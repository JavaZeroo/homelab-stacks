# ---- Jellyfin on subpath /jellyfin ----

# 访问 /jellyfin 时补上结尾斜杠，避免相对路径问题
location = /jellyfin {
    return 301 /jellyfin/;
}

# Web UI 静态资源（可选：单独拎出来，便于将来做静态缓存）
location ^~ /jellyfin/web/ {
    proxy_pass http://192.168.3.210:8096;
    proxy_http_version 1.1;

    # 透传 Host/源 IP/协议/端口，保证外链与回调正确
    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host  $http_host;
    proxy_set_header X-Forwarded-Port  $server_port;

    proxy_redirect off;

    # （静态资源可以打开缓冲，默认即可）
    # proxy_buffering on;
}

# WebSocket（会话/播放状态等）
location ^~ /jellyfin/socket {
    proxy_pass http://192.168.3.210:8096;
    proxy_http_version 1.1;

    # 你在主 server 块里已用 map 定义了 $connection_upgrade
    proxy_set_header Upgrade    $http_upgrade;
    proxy_set_header Connection $connection_upgrade;

    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host  $http_host;
    proxy_set_header X-Forwarded-Port  $server_port;

    proxy_read_timeout 36000s;
    proxy_send_timeout 36000s;
    proxy_redirect off;

    # WebSocket/流式不建议缓冲
    proxy_buffering off;
}

# 其它所有 Jellyfin 接口与媒体流
location ^~ /jellyfin/ {
    proxy_pass http://192.168.3.210:8096;
    proxy_http_version 1.1;

    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host  $http_host;
    proxy_set_header X-Forwarded-Port  $server_port;

    proxy_read_timeout 36000s;
    proxy_send_timeout 36000s;
    proxy_redirect off;

    # 流媒体：关闭缓冲，避免卡顿；上传（如插件/图像）不限制体积
    proxy_buffering off;
    proxy_request_buffering off;
    client_max_body_size 0;

    # 让客户端可进行 Range 请求（快进/拖动）
    add_header X-Accel-Buffering no;
}
